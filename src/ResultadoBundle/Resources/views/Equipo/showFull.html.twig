{% extends 'CommonBundle::layout.html.twig' %}

{% block contenidoToolbar %}
    <div class="toolbar row">
        <div class="col-sm-6 hidden-xs">
            <div class="page-header">
                <h1><i class="fa fa-edit"></i> Detalle de equipo <small></small></h1>
            </div>
        </div>
        <div class="col-sm-6 col-xs-12">
            <a href="#" class="close-subviews">
                <i class="fa fa-arrow-left"></i> VOLVER
            </a>
            <div class="toolbar-tools pull-right">
                <!-- start: TOP NAVIGATION MENU -->
                <ul class="nav navbar-right">
                    <li>
                        <a href="javascript:window.location.href=document.referrer">
                            <i class="fa fa-arrow-left"></i> VOLVER
                        </a>
                    </li>
                </ul>
                <!-- end: TOP NAVIGATION MENU -->
            </div>
        </div>
    </div>
{% endblock %}
{% block contenidoBreadcrumb %}
    <div class="row">
        <div class="col-md-12">
            <ol class="breadcrumb">
                <li>
                    <a href="{{ path('homepage') }}">
                        <i class="fa fa-home" aria-hidden="true"></i>
                    </a>
                </li>
                <li>
                    Resultados
                </li>
                <li>
                    Equipo
                </li>
                <li class="active">
                    Detalle
                </li>
            </ol>
        </div>
    </div>
{% endblock %}
{% block contenidoData %}
    <div class="panel-heading border-light">
        <h4 class="panel-title">Información <span class="text-bold">del Equipo</span></h4>
        <ul class="panel-heading-tabs border-light">
            <li>
                <div class="pull-right" style="font-size: 20px" title="ID del Participante">
                    <i class="fa fa-key text-yellow"></i><span class="text-bold"> {{ equipo.id }} </span>
                </div>
            </li>
            <li>
                <div class="pull-right" style="font-size: 20px" title="Cantidad de integrantes">
                    <i class="fa fa-users text-green"></i><span class="text-bold"> {{ equipo.getIntegrantes | length }} </span>
                </div>
            </li>
            <li>
                <div class="pull-right" style="font-size: 20px" title="Cantidad de etapas">
                    <i class="fa fa-dot-circle-o text-red"></i><span class="text-bold"> {{ equipo.etapas | length }} </span>
                </div>
            </li>
            <li class="panel-tools">
                {{ include('CommonBundle::dropdownTables.html.twig') }}
            </li>
        </ul>
    </div>
    <div class="panel-body">
        <div class="row">
            <div class="col-sm-5 col-md-4">
                <div class="user-left">
                    <div class="center">
                        <h4>{{ equipo.getNombre }}</h4>
                        <div class="fileupload fileupload-new" data-provides="fileupload">
                            <div class="user-image">
                                <div class="fileupload-new thumbnail">
                                    <i class="fa fa-users fa-5x"></i>
                                </div>
                            </div>
                        </div>
                        <hr>
                    </div>
                    <table class="table table-condensed table-hover">
                        <thead>
                            <tr>
                                <th colspan="3"><i class="fa fa-info-circle"></i> Planilla</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Número:</td>
                                <td>{{ equipo.planilla.numero }}</td>
                            </tr>
                            <tr>
                                <td>Municipio:</td>
                                <td>{{ equipo.planilla.municipio }}</td>
                            </tr>
                            <tr>
                                <td>Tipo</td>
                                <td>{{ equipo.planilla.getTipoInscripcion() }}</td>
                            </tr>
                        </tbody>
                    </table>
                    <table class="table table-condensed table-hover">
                        <thead>
                            <tr>
                                <th colspan="3"><i class="fa fa-info-circle"></i> Técnico</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Nombre</td>
                                <td>{{ equipo.planilla.directorTecnicoNombre }}</td>
                            </tr>
                            <tr>
                                <td>Apellido</td>
                                <td>{{ equipo.planilla.directorTecnicoApellido }}</td>
                            </tr>
                            <tr>
                                <td>DNI</td>
                                <td>{{ equipo.planilla.directorTecnicoDni }}</td>
                            </tr>
                        </tbody>
                    </table>
                    <table class="table table-condensed table-hover">
                        <thead>
                            <tr>
                                <th colspan="3"><i class="fa fa-history"></i> Auditoría</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Creado por</td>
                                <td>{{ equipo.planilla.createdBy }}</td>
                            </tr>
                            <tr>
                                <td>Creado el</td>
                                <td>{{ equipo.planilla.createdAt | date('d/m/y') }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="col-sm-7 col-md-8">
                <p class="">
                    A continuación se presenta información y estadisticas del equipo con el objetivo de realizar un seguimiento detallado de su desempeño a lo largo del certamen.
                </p>
                <div class="row space20">
                    <div class="col-sm-6">
                        <div class="panel panel-default panel-white core-box">
                            <div class="panel-body no-padding">
                                <div class="partition-red padding-20 text-center core-icon" style="width: 25% !important;">
                                    <i class="fa fa-edit fa-2x icon-big"></i>
                                </div>
                                <div class="padding-20 core-content" style="margin-left: 25%">
                                    <h3 class="title block no-margin">Segmento</h3>
                                    <span class="subtitle"> {{ equipo.planilla.segmento.getNombreCompletoRaw | raw }} </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="panel panel-default panel-white core-box">
                            <div class="panel-body no-padding">
                                <div class="partition-green padding-20 text-center core-icon" style="width: 25% !important;">
                                    <i class="fa fa-trophy fa-2x icon-big"></i>
                                </div>
                                <div class="padding-20 core-content" style="margin-left: 25%">
                                    <h3 class="title block no-margin">Evento</h3>
                                    {% if equipo.etapas %}
                                        <span class="subtitle"> {{ equipo.etapas[0].evento.getNombreCompletoRaw | raw }} </span>
                                    {% else %}
                                        <span class="subtitle">No está inscripto a eventos.</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="panel panel-white space20">
                    <div class="panel-heading">
                        <h4 class="no-margin"><i class="fa fa-list"></i> Integrantes: <small>{{ equipo.getEquipoCompetidores | length }}</small></h4>
                    </div>
                    <div class="panel-body panel-scroll-local height-300 ps-container">
                        <ul class="activities">
                            {% for equioCompetidor in equipo.getEquipoCompetidores %}
                                <li>
                                    <a class="activity">
                                        <div class="fa-stack fa-lg pull-left">
                                            {% if equioCompetidor.rol == "inscripto" %}
                                                <i class="fa fa-user fa-lg text-green" title="Titular"></i>
                                            {% elseif equioCompetidor.rol == "sustituto" %}
                                                <i class="fa fa-user-o fa-lg text-green" title="Sustituto"></i>
                                            {% else %}
                                                <i class="fa fa-user-times fa-lg text-red" title="Reemplazado"></i>
                                            {% endif %}
                                        </div>
                                        <div class="desc cursor-pointer" onclick="$.Equipo.competidor.show({{ equioCompetidor.competidor.id }})">
                                            <div class="pull-left">
                                                {{ equioCompetidor.competidor.getNombreCompleto }}<br>
                                                <small>DNI: {{ equioCompetidor.competidor.dni }}</small>
                                            </div>
                                            <div class="pull-right">
                                                {% if equioCompetidor.competidor.equipos | length > 2%}
                                                    Participa en<br>
                                                    {{ equioCompetidor.competidor.equipos | length -1 }} segmentos más
                                                {% elseif equioCompetidor.competidor.equipos | length > 1%}
                                                        Participa en<br>
                                                        1 segmento más
                                                {% else %}
                                                    No participa<br>
                                                    en otros segmento
                                                {% endif %}
                                            </div>
                                            <div class="clearfix"></div>
                                        </div>
                                        <div class="time" style="top: 30% !important;">
                                            {% if equioCompetidor.rol == "inscripto" and  is_granted('ROLE_RESULTADO_EQUIPO_CAMBIOS') and (is_granted('ROLE_COORDINADOR') or is_granted('ROLE_ADMIN') or equipo.planilla.municipio == app.user.municipio) %}
                                                <button onclick="$.Equipo.competidor.sustituciones({{ equioCompetidor.id }})" class="btn btn-xs btn-green tooltips show-sv" data-placement="top" data-original-title="Reemplazar" data-startFrom="right">
                                                    <i class="fa fa-exchange"></i>
                                                </button>
                                            {% endif %}
                                            {% if equioCompetidor.entra and is_granted('ROLE_ADMIN') %}
                                                <button onclick="$.Equipo.competidor.sustituciones({{ equioCompetidor.id }})" class="btn btn-xs btn-purple tooltips show-sv" data-placement="top" data-original-title="Rollback" data-startFrom="right">
                                                    <i class="fa fa-history"></i>
                                                </button>
                                            {% endif %}
                                        </div>
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="panel-footer padding-10">
                        <div class="padding-horizontal-15 pull-left"><i class="fa fa-user fa-lg text-green"></i> Titular</div>
                        <div class="padding-horizontal-15 pull-left"><i class="fa fa-user-o fa-lg text-green"></i> Sustituto</div>
                        <div class="padding-horizontal-15 pull-left"><i class="fa fa-user-times fa-lg text-red"></i> Competidor reemplazado</div>
                        <div class="clearfix"></div>
                    </div>
                </div>
                <div class="panel panel-white space20">
                    <div class="panel-heading">
                        <h4 class="no-margin"><i class="fa fa-list"></i> Etapas</h4>
                    </div>
                    <div class="panel-body panel-scroll-local height-300 ps-container">
                        <ul class="activities">
                            {% for etapa in equipo.etapas %}
                                <li>
                                    <a class="activity">
                                        <div class="fa-stack fa-2x pull-left" style="margin-top: -5px;">
                                            <i class="fa fa-dot-circle-o text-orange"></i>
                                        </div>
                                        <div class="desc">
                                            {{ etapa.getNombre }}<br>
                                            <small>{{ etapa.equipos | length }} equipos</small>
                                        </div>
                                        <div class="time">
                                            <i class="fa fa-play"></i>
                                            <strong>
                                                {{ etapa.getState }} %
                                            </strong>
                                        </div>
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block otherJavascripts %}
    <script>
        (function ($) {
            var pathCompetidorShow = "{{ path('competidor_show') }}",
                pathCompetidorSustitucion = "{{ path('equipo_competidor_sustitucion') }}",
                _tableLoaded = false;
            // no se sobreescribe el namespace, si ya existe
            $.Equipo = $.Equipo || {};
            $.Equipo.init = function()
            {
                $('.panel-scroll-local').perfectScrollbar();
            }
            $.Equipo.competidor = {},
            $.Equipo.competidor.show = function(id)
            {
                window.location.href = pathCompetidorShow.replace('__00__', id);
            }
            $.Equipo.competidor.sustituciones = function(id)
            {
                _tableLoaded = false;
                $('#globalSubView .subviews-container').load(pathCompetidorSustitucion.replace('__00__', id));

            }
            $.Equipo.competidor.sustituciones.showHelp = function()
            {
                $('#panel-config .modal-footer').hide();
                //$('#panel-config .modal-dialog').addClass('modal-lg');
                $('#panel-config .modal-title').html('<i class="fa fa-question-circle" aria-hidden="true"></i> Ayuda para sustituciones/reemplazos');
                $('#panel-config .modal-body').html('<div class="row">'+
                                                        '<div class="col-sm-12">'+
													        '<h4 class="no-margin text-danger"><i class="fa fa-comment-o" aria-hidden="true"></i> Sustituciones</h4>'+
				                                            'Las sustituciones, son los cambios realizados dentro del equipo por competidores inscriptos en la misma planilla.<br>'+
                                                            'Por defecto la tabla izquierda muestra las posibles sustituciones en un equipo.<br>'+
	                                                    '</div><div class="col-sm-12"></br>'+
													        '<h4 class="no-margin text-danger"><i class="fa fa-comment-o" aria-hidden="true"></i> Reemplazos</h4>'+
				                                            'Los reemplazos, son los cambios realizados por competidores de otro equipo que haya paticipado en el mismo segmento de inscripción.<br>'+
                                                            'Para cambiar a la tabla de reemplazos posibles debe hace click en <b>Buscar reemplazo</b>.'+
	                                                   '</div><div class="col-sm-12"><br>'+
                                                       '<h4 class="no-margin text-danger"><i class="fa fa-comment-o" aria-hidden="true"></i> ATENCIÓN</h4>'+
                                                       'Tanto los reemplazos como sustituciones son irreversibles. No guarde si no está realmente seguro del cambio.<br>'+
                                                       'Una vez seleccionado el reemplazo bastan con hacer click en <b>Confirmar</b> para completar el proceso.'+
                                                     '</div>');
                $('#panel-config').modal();
            }
            $.Equipo.competidor.select = function(id)
            {
                $('#sustitucion_entra').data('entra',id);
                $('#sustitucion_entra').html($('#row_'+id).children().eq(1).html()+'<br><small>DNI: '+$('#row_'+id).children().eq(2).html()+'</small>');
            }
            $.Equipo.competidor.confirmarCambio = function()
            {
                let equipoEntra = $('#sustitucion_entra').data('entra'),
                    equipoCompetidor = $('#sustitucion_sale').data('equipocompetidor');
                if (equipoEntra){
                    swal({
                        title: 'Seguro quiere sustituir a este competidor?',
                        text: 'Los cambios sin irreversibles',
                        type: "warning",
                        html: true,
                        closeOnConfirm: false,
                        animation: "slide-from-top",
                        showCancelButton: true,
                        cancelButtonColor: '#d33',
                        cancelButtonText: 'Cancelar',
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'Sí, seguro',
                        closeOnCancel: true,
                    },function () {
                        $.post(pathCompetidorSustitucion.replace('__00__', equipoCompetidor),{'equipoEntra' : equipoEntra})
                            .done((data)=>{
                                if (data.success){
                                    swal({
                                        title: 'Excelente',
                                        text: data.message,
                                        type: "success",
                                    },function (){
                                        location.reload();
                                    });
                                }else{
                                    swal('Cuidado!',data.message,'error')
                                }
                            })
                            .fail(()=>{
                                swal('Cuidado!','Ocurrio un error en la comunicación con el servidor','error')
                            }).always(()=>{
                            })
                    })
                }else{
                    toastr['warning']('Debe seleccionar un competidor.', 'Cuidado!');
                }
            }
            $.Equipo.competidor.sustituciones.table = function()
            {

                $('#reemplazosTable').parents('.table-responsive').addClass('hide');
                $('#sustitutosTable').parents('.table-responsive').removeClass('hide');
                $('#buscarSustituto').addClass('hide');
                $('#buscarReemplazo').removeClass('hide');
            }

            $.Equipo.competidor.reemplazos = {},
            $.Equipo.competidor.reemplazos.table = function()
            {
                $('#buscarSustituto').removeClass('hide');
                $('#buscarReemplazo').addClass('hide');
                $('#sustitutosTable').parents('.table-responsive').addClass('hide');
                $('#reemplazosTable').parents('.table-responsive').removeClass('hide');
                if (!_tableLoaded){
                    _tableLoaded = true;
                    _tableCompetidor = $('#reemplazosTable').dataTable( {
                        "autoWidth": false,
                        "processing": true,
                        "serverSide": true,
                        "ajax": {
                            "url": '{{ path('competidor_list_datatable_segmento', {'segmento': equipo.planilla.segmento.id}) }}',
                            "type": 'POST'
                        },
                        "language" : {
                            "url" : "{{ asset('assets/common/Spanish.json') }}"
                        },
                        "columns": [
                            { "data": "id", "className": "text-center" },
                            { "data":  "name"},
                            { "data": "dni" },
                            { "data": "actions" }
                        ],
                        "bInfo": false,
                        "bFilter" : true,
                        "order": [[ 1, 'asc' ]],
                        "pageLength" : 25,
                        "columnDefs": [
                            {
                                "searchable": false,
                                "orderable": false,
                                "targets": [3]
                            },
                            {
                                "targets": 1,
                                "searchable": true,
                                "orderable": true,
                                "render":   function ( data, type, full, meta ) {
                                                return type === 'display' ?
                                                        full.name + '<br><small>' + full.municipio + '</small>'
                                                    :'';
                                            }
                            },
                            {
                                "targets": 3,
                                "searchable": true,
                                "orderable": true,
                                "render":   function ( data, type, full, meta ) {
                                                return type === 'display' ?
                                                        $(data).html('<button onclick="$.Equipo.competidor.select('+full.id+')" class="btn btn-xs btn-orange"><i class="fa fa-arrow-right"></i></button>').html()
                                                    :'';
                                            }
                            }
                        ],
                        "fnCreatedRow": function( nRow, aData, iDataIndex ) {
                            $(nRow).attr({'id': 'row_'+aData.id,'draggable': true})
                                .on('dragstart',function(ev){
                                    ev.originalEvent.dataTransfer.setData("row",ev.target.id);
                            });
                            return nRow;
                        },
                        "fnDrawCallback": function(oSettings, json) {
                            $('[data-toggle="popover"]').popover();
                            $('#competidorTable_paginate').parent().removeClass('col-sm-7').addClass('col-sm-12')
                        }
                    });
                }
            }
        })(jQuery);
        $(document).ready(function(){$.Equipo.init();});
    </script>
{% endblock %}
